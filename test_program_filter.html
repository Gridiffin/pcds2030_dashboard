<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Program Selection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .log-entry { margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee; }
        .error { color: red; }
        #output { max-height: 400px; overflow-y: auto; }
        .program-checkbox:checked + label { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Program Selection</h1>
        
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="periodSelect" class="form-label">Reporting Period</label>
                        <select id="periodSelect" class="form-select" required>
                            <option value="">Select Reporting Period</option>
                            <!-- Will be populated via API -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="sectorSelect" class="form-label">Sector</label>
                        <select id="sectorSelect" class="form-select">
                            <option value="">All Sectors</option>
                            <!-- Will be populated via API -->
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button id="testBtn" class="btn btn-primary">Test Programs API</button>
                </div>
                
                <div id="programSelector" class="border rounded p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                    <div class="d-flex justify-content-between mb-2">
                        <h5 class="mb-0">Programs</h5>
                        <div>
                            <button id="selectAllBtn" class="btn btn-sm btn-outline-primary me-1">Select All</button>
                            <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">Deselect All</button>
                        </div>
                    </div>
                    <div id="programsContainer">
                        <!-- Programs will be loaded here -->
                        <div class="text-center py-4 text-muted">Select a period to load programs</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button id="logSelectedBtn" class="btn btn-info">Log Selected Programs</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Output Log</h5>
                <button id="clearLogBtn" class="btn btn-sm btn-secondary">Clear Log</button>
            </div>
            <div class="card-body">
                <div id="output" class="bg-light p-3 border rounded">
                    <div class="log-entry">Ready to test...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const periodSelect = document.getElementById('periodSelect');
            const sectorSelect = document.getElementById('sectorSelect');
            const testBtn = document.getElementById('testBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const logSelectedBtn = document.getElementById('logSelectedBtn');
            const clearLogBtn = document.getElementById('clearLogBtn');
            const programsContainer = document.getElementById('programsContainer');
            const output = document.getElementById('output');
            
            // Log a message to the output div
            function log(message, isError = false) {
                const entry = document.createElement('div');
                entry.className = `log-entry${isError ? ' error' : ''}`;
                entry.textContent = message;
                output.appendChild(entry);
                output.scrollTop = output.scrollHeight;
            }
            
            // Load periods
            function loadPeriods() {
                log('Loading reporting periods...');
                
                fetch('../../api/get_periods.php')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.periods && data.periods.length > 0) {
                            periodSelect.innerHTML = '<option value="">Select Reporting Period</option>';
                            
                            data.periods.forEach(period => {
                                let display = `Q${period.quarter} ${period.year}`;
                                if (period.quarter == 5) display = `Half Yearly 1 ${period.year}`;
                                if (period.quarter == 6) display = `Half Yearly 2 ${period.year}`;
                                
                                const option = document.createElement('option');
                                option.value = period.period_id;
                                option.textContent = display;
                                periodSelect.appendChild(option);
                            });
                            
                            log(`Loaded ${data.periods.length} periods`);
                        } else {
                            log('No periods found', true);
                        }
                    })
                    .catch(error => {
                        log(`Error loading periods: ${error.message}`, true);
                    });
            }
            
            // Load sectors
            function loadSectors() {
                log('Loading sectors...');
                
                fetch('../../api/get_sectors.php')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.sectors && data.sectors.length > 0) {
                            sectorSelect.innerHTML = '<option value="">All Sectors</option>';
                            
                            data.sectors.forEach(sector => {
                                const option = document.createElement('option');
                                option.value = sector.sector_id;
                                option.textContent = sector.sector_name;
                                sectorSelect.appendChild(option);
                            });
                            
                            log(`Loaded ${data.sectors.length} sectors`);
                        } else {
                            log('No sectors found', true);
                        }
                    })
                    .catch(error => {
                        log(`Error loading sectors: ${error.message}`, true);
                    });
            }
            
            // Load programs for selected period and sector
            function loadPrograms() {
                const periodId = periodSelect.value;
                const sectorId = sectorSelect.value;
                
                if (!periodId) {
                    programsContainer.innerHTML = '<div class="text-center py-4 text-muted">Select a period to load programs</div>';
                    return;
                }
                
                log(`Loading programs for period ${periodId}${sectorId ? ` and sector ${sectorId}` : ''}...`);
                programsContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>';
                
                const url = `../../api/get_period_programs.php?period_id=${periodId}${sectorId ? '&sector_id=' + sectorId : ''}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.success && data.programs) {
                            log('Programs loaded successfully');
                            
                            const programCount = Object.values(data.programs).reduce((sum, sector) => 
                                sum + (sector.programs ? sector.programs.length : 0), 0);
                            
                            log(`Found ${programCount} programs across ${Object.keys(data.programs).length} sectors`);
                            
                            renderPrograms(data.programs, sectorId);
                        } else {
                            log('Error in programs response: ' + (data.error || 'Unknown error'), true);
                            programsContainer.innerHTML = '<div class="alert alert-danger">Error loading programs</div>';
                        }
                    })
                    .catch(error => {
                        log(`Error loading programs: ${error.message}`, true);
                        programsContainer.innerHTML = '<div class="alert alert-danger">Failed to load programs</div>';
                    });
            }
            
            // Render programs in the UI
            function renderPrograms(programs, selectedSectorId) {
                if (Object.keys(programs).length === 0) {
                    programsContainer.innerHTML = '<div class="alert alert-warning">No programs available for the selected period</div>';
                    return;
                }
                
                let html = '';
                
                for (const sectorId in programs) {
                    const sectorData = programs[sectorId];
                    const isVisible = !selectedSectorId || sectorId === selectedSectorId;
                    
                    html += `
                        <div class="sector-programs mb-3" data-sector-id="${sectorId}" style="display: ${isVisible ? 'block' : 'none'}">
                            <h6 class="fw-bold mb-2">${sectorData.sector_name}</h6>
                            <div class="ps-3">
                    `;
                    
                    if (sectorData.programs && sectorData.programs.length > 0) {
                        sectorData.programs.forEach(program => {
                            html += `
                                <div class="form-check mb-2">
                                    <input class="form-check-input program-checkbox" 
                                           type="checkbox" 
                                           name="program_ids[]" 
                                           value="${program.program_id}" 
                                           id="program_${program.program_id}">
                                    <label class="form-check-label" for="program_${program.program_id}" style="word-break: break-word; white-space: normal;">
                                        ${program.program_name}
                                    </label>
                                </div>
                            `;
                        });
                    } else {
                        html += '<div class="text-muted">No programs in this sector</div>';
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                programsContainer.innerHTML = html;
            }
            
            // Log selected programs
            function logSelectedPrograms() {
                const selectedPrograms = [];
                document.querySelectorAll('.program-checkbox:checked').forEach(checkbox => {
                    const label = document.querySelector(`label[for="${checkbox.id}"]`).textContent.trim();
                    selectedPrograms.push({
                        id: checkbox.value,
                        name: label
                    });
                });
                
                log(`Selected ${selectedPrograms.length} programs:`);
                if (selectedPrograms.length > 0) {
                    selectedPrograms.forEach(prog => {
                        log(`  - ID: ${prog.id}, Name: ${prog.name}`);
                    });
                } else {
                    log('  (none)');
                }
            }
            
            // Select all visible programs
            function selectAllPrograms() {
                const visibleSectors = document.querySelectorAll('.sector-programs:not([style*="display: none"])');
                visibleSectors.forEach(sector => {
                    const checkboxes = sector.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                });
                log('Selected all visible programs');
            }
            
            // Deselect all visible programs
            function deselectAllPrograms() {
                const visibleSectors = document.querySelectorAll('.sector-programs:not([style*="display: none"])');
                visibleSectors.forEach(sector => {
                    const checkboxes = sector.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                });
                log('Deselected all visible programs');
            }
            
            // Event listeners
            testBtn.addEventListener('click', loadPrograms);
            periodSelect.addEventListener('change', loadPrograms);
            sectorSelect.addEventListener('change', loadPrograms);
            selectAllBtn.addEventListener('click', selectAllPrograms);
            deselectAllBtn.addEventListener('click', deselectAllPrograms);
            logSelectedBtn.addEventListener('click', logSelectedPrograms);
            clearLogBtn.addEventListener('click', () => {
                output.innerHTML = '<div class="log-entry">Log cleared</div>';
            });
            
            // Initialize
            try {
                loadPeriods();
                loadSectors();
            } catch (error) {
                log(`Initialization error: ${error.message}`, true);
            }
        });
    </script>
</body>
</html>
